<html lang="zh-CN">
<head> 
  <meta charset="UTF-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>心灵治愈时刻</title> 
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #fff;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-image: url('https://img0.baidu.com/it/u=1854394975,3510280552&fm=253&fmt=auto&app=138&f=JPEG?w=800&h=1200');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            transition: background-image 0.5s ease;
        }
        
        .container {
            text-align: center;
            position: relative;
            width: 100%;
            max-width: 800px;
            padding: 20px;
        }
        
        #startButton {
            padding: 15px 30px;
            font-size: 18px;
            background: linear-gradient(45deg, #ff7eb3, #ff758c, #ff8e53, #ffcc33);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 126, 179, 0.4);
            transition: all 0.3s ease;
            z-index: 10;
            position: relative;
            font-weight: bold;
            letter-spacing: 1px;
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        #startButton:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 126, 179, 0.6);
        }
        
        #playerContainer {
            display: none;
            position: relative;
            width: 100%;
            height: 400px;
            margin-top: 30px;
        }
        
        .visualizer {
            position: absolute;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            overflow: hidden;
        }
        
        .wave {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            opacity: 0.6;
            transform-origin: center;
        }
        
        .wave-1 {
            background: radial-gradient(circle, rgba(255,126,179,0.3) 0%, rgba(255,126,179,0) 70%);
            animation: pulse 4s infinite ease-in-out;
        }
        
        .wave-2 {
            background: radial-gradient(circle, rgba(117,255,210,0.3) 0%, rgba(117,255,210,0) 70%);
            animation: pulse 5s infinite ease-in-out 0.5s;
        }
        
        .wave-3 {
            background: radial-gradient(circle, rgba(255,228,117,0.3) 0%, rgba(255,228,117,0) 70%);
            animation: pulse 6s infinite ease-in-out 1s;
        }
        
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.6; }
            50% { transform: scale(1.2); opacity: 0.3; }
            100% { transform: scale(0.8); opacity: 0.6; }
        }
        
        .note {
            position: absolute;
            font-size: 60px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: float 3s infinite ease-in-out;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.7));
            z-index: 5;
        }
        
        .note-shadow {
            position: absolute;
            font-size: 60px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            animation: shadow 3s infinite ease-in-out;
            z-index: 4;
        }
        
        @keyframes float {
            0%, 100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
            50% { transform: translate(-50%, -55%) scale(1.1) rotate(5deg); }
        }
        
        @keyframes shadow {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.3; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.4); }
        }
        
        .controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            z-index: 10;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        label {
            font-size: 14px;
            color: #ccc;
        }
        
        input[type="range"] {
            width: 100px;
            -webkit-appearance: none;
            height: 5px;
            background: #555;
            border-radius: 5px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #ff7eb3;
            cursor: pointer;
        }
        
        button.control-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        button.control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        button.control-btn.active {
            background: #ff7eb3;
            color: white;
        }
        
        .particles {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 1;
        }
        
        .particle {
            position: absolute;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            animation: float-up 5s infinite linear;
        }
        
        @keyframes float-up {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }
        
        .title {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 24px;
            color: white;
            text-shadow: 0 0 10px rgba(255, 126, 179, 0.7);
            z-index: 10;
        }
        
        .url-input-container {
            position: absolute;
            top: -160px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            z-index: 20;
        }
        
        .url-input {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            width: 70%;
            max-width: 500px;
            outline: none;
            font-size: 14px;
        }
        
        .url-submit {
            background: rgba(255, 126, 179, 0.7);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .url-submit:hover {
            background: rgba(255, 126, 179, 0.9);
        }
        
        .file-input-container {
            position: absolute;
            top: -100px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            z-index: 20;
        }
        
        .file-input-label {
            background: rgba(255, 126, 179, 0.7);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            display: flex;
            align-items: center;
        }
        
        .file-input-label:hover {
            background: rgba(255, 126, 179, 0.9);
        }
        
        #fileInput {
            display: none;
        }
        
        .video-container {
            position: absolute;
            width: 200px;
            height: 150px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, calc(-50% - 100px));
            z-index: 6;
            display: none;
        }
        
        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        
        .copyright {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 12px;
            background: linear-gradient(90deg, #ff7eb3, #ff758c, #ff8e53, #ffcc33);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            z-index: 20;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }

        /* 新增的音乐搜索区域样式 */
        .music-search-container {
            position: absolute;
            top: -220px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            z-index: 20;
        }
        
        .api-selector {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            outline: none;
            font-size: 14px;
            cursor: pointer;
            backdrop-filter: blur(5px);
        }
        
        .music-search-input {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            width: 40%;
            max-width: 300px;
            outline: none;
            font-size: 14px;
        }
        
        .music-search-btn {
            background: rgba(255, 126, 179, 0.7);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .music-search-btn:hover {
            background: rgba(255, 126, 179, 0.9);
        }
        
        .search-results {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 600px;
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 10px;
            display: none;
            z-index: 30;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        
        .search-result-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }
        
        .search-result-item:hover {
            background: rgba(255, 126, 179, 0.2);
        }
        
        .result-cover {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            object-fit: cover;
        }
        
        .result-info {
            flex: 1;
            overflow: hidden;
        }
        
        .result-title {
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .result-artist {
            font-size: 12px;
            color: #ccc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* 新增的背景图片选择按钮 */
        #bgImageInput {
            display: none;
        }
        
        .bg-change-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            padding: 3px 6px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 7px;
            z-index: 20;
        }
        
        .bg-change-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* 全屏样式 */
        :fullscreen {
            background-color: #1a1a2e;
        }
        
        :-webkit-full-screen {
            background-color: #1a1a2e;
        }
        
        :-moz-full-screen {
            background-color: #1a1a2e;
        }
        
        /* 全屏按钮样式 */
        .fullscreen-btn {
            position: absolute;
            bottom: 65px;
            right: 20px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            z-index: 20;
        }
        
        .fullscreen-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
    </style> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
 </head> 
 <body id="v1"> 
  <div id="v2" class="container"> 
   <button id="startButton">🎵  ᝰ开启心灵治愈时刻 🎶</button> 
   <div id="playerContainer"> 
    <div id="v3" class="title">
     心灵治愈音乐
    </div> 
    <!-- 新增的音乐搜索区域 --> 
    <div id="v4" class="music-search-container"> 
     <select class="api-selector" id="apiSelector"> <option id="v5" value="netease">网易云音乐</option> <option id="v6" value="tencent">QQ音乐</option> <option id="v7" value="kugou">酷狗音乐</option> </select> 
     <input type="text" class="music-search-input" id="musicSearchInput" placeholder="搜索歌曲..."> 
     <button class="music-search-btn" id="musicSearchBtn"> <i id="v8" class="fas fa-search"></i> 搜索 </button> 
     <div class="search-results" id="searchResults" style="display: none;"></div> 
    </div> 
    <div id="v9" class="url-input-container"> 
     <input type="text" class="url-input" id="audioUrlInput" placeholder="输入音频直链地址..."> 
     <button class="url-submit" id="urlSubmitBtn">确认</button> 
    </div> 
    <div id="v10" class="file-input-container"> 
     <label id="v11" for="fileInput" class="file-input-label">📁 选择音频/视频文件</label> 
     <input type="file" id="fileInput" accept="audio/*,video/*"> 
    </div> 
    <div class="video-container" id="videoContainer" style="display: none;"> 
     <video id="videoElement" controls="" loop></video> 
    </div> 
    <div id="v12" class="visualizer"> 
     <div id="v13" class="wave wave-1"></div> 
     <div id="v14" class="wave wave-2"></div> 
     <div id="v15" class="wave wave-3"></div> 
     <div id="v16" class="note">
      🎵
     </div> 
     <div id="v17" class="note-shadow">
      🎵
     </div> 
    </div> 
    <div class="particles" id="particles"></div> 
    <div id="v18" class="controls"> 
     <div id="v19" class="control-group"> 
      <button id="playPauseBtn" class="control-btn">▶ 播放</button> 
     </div> 
     <div id="v20" class="control-group"> 
      <label id="v21" for="volume">音量</label> 
      <input type="range" id="volume" min="0" max="1" step="0.01" value="0.7"> 
     </div> 
     <div id="v22" class="control-group"> 
      <label id="v23" for="playbackRate">速度</label> 
      <input type="range" id="playbackRate" min="0.5" max="2" step="0.1" value="1"> 
     </div> 
     <div id="v24" class="control-group"> 
      <label id="v25" for="pitch">音调</label> 
      <input type="range" id="pitch" min="0.5" max="2" step="0.1" value="1"> 
     </div> 
     <div id="v26" class="control-group"> 
      <button id="loopBtn" class="control-btn">🔁 单曲循环</button> 
     </div> 
    </div> 
    <button class="bg-change-btn" id="bgChangeBtn">🎨 更换背景</button>
    <button class="fullscreen-btn" id="fullscreenBtn">⛶ 全屏</button>
    <input type="file" id="bgImageInput" accept="image/*">
    <div id="v27" class="copyright">
     zhu创作
    </div> 
   </div> 
  </div> 
  <!-- 引入Font Awesome图标库 --> 
  <link id="v28" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> 
  <!-- 引入APlayer和MetingJS --> 
  <script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script> 
  <script src="https://cdn.jsdelivr.net/npm/meting@2.0.1/dist/Meting.min.js"></script> 
  <script>
        document.addEventListener('DOMContentLoaded', function() {
            const startButton = document.getElementById('startButton');
            const playerContainer = document.getElementById('playerContainer');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const volumeControl = document.getElementById('volume');
            const playbackRateControl = document.getElementById('playbackRate');
            const pitchControl = document.getElementById('pitch');
            const loopBtn = document.getElementById('loopBtn');
            const particlesContainer = document.getElementById('particles');
            const audioUrlInput = document.getElementById('audioUrlInput');
            const urlSubmitBtn = document.getElementById('urlSubmitBtn');
            const fileInput = document.getElementById('fileInput');
            const videoContainer = document.getElementById('videoContainer');
            const videoElement = document.getElementById('videoElement');
            const bgChangeBtn = document.getElementById('bgChangeBtn');
            const bgImageInput = document.getElementById('bgImageInput');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            
            // 新增的音乐搜索元素
            const apiSelector = document.getElementById('apiSelector');
            const musicSearchInput = document.getElementById('musicSearchInput');
            const musicSearchBtn = document.getElementById('musicSearchBtn');
            const searchResults = document.getElementById('searchResults');
            
            let audioContext;
            let audioBuffer;
            let sourceNode;
            let isPlaying = false;
            let isLooping = false;
            let playbackRate = 1;
            let detune = 0;
            let currentMediaSource = null;
            
            // 默认视频URL - 即使失效也能进入
            const defaultVideoUrl = 'https://vdse.bdstatic.com//2f50e6009bbd34deada98859395e9c6a.mp4?authorization=bce-auth-v1%2F40f207e648424f47b2e3dfbb1014b1a5%2F2025-07-18T08%3A53%3A41Z%2F-1%2Fhost%2Fa05de2effb5a7ee715166c1d6d0c9a616c99849e9f05d17b2dc1e6e005709ec7';
            
            // 初始化MetingJS播放器
            let metingPlayer = null;
            
            function initMetingPlayer() {
                if (window.MetingJSElement) {
                    metingPlayer = new MetingJSElement({
                        container: document.createElement('div'),
                        api: 'https://api.i-meto.com/meting/api',
                        fixed: false,
                        autoplay: false
                    });
                }
            }
            
            // 全屏功能
            function toggleFullscreen() {
                if (!document.fullscreenElement) {
                    // 进入全屏
                    if (document.documentElement.requestFullscreen) {
                        document.documentElement.requestFullscreen().catch(err => {
                            console.log(`全屏错误: ${err.message}`);
                        });
                    } else if (document.documentElement.webkitRequestFullscreen) {
                        document.documentElement.webkitRequestFullscreen();
                    } else if (document.documentElement.mozRequestFullScreen) {
                        document.documentElement.mozRequestFullScreen();
                    } else if (document.documentElement.msRequestFullscreen) {
                        document.documentElement.msRequestFullscreen();
                    }
                } else {
                    // 退出全屏
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    } else if (document.mozCancelFullScreen) {
                        document.mozCancelFullScreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    }
                }
            }
            
            // 自动全屏函数
            function autoFullscreen() {
                // 延迟执行以确保元素已显示
                setTimeout(() => {
                    if (!document.fullscreenElement) {
                        if (document.documentElement.requestFullscreen) {
                            document.documentElement.requestFullscreen().catch(err => {
                                console.log(`自动全屏错误: ${err.message}`);
                            });
                        } else if (document.documentElement.webkitRequestFullscreen) {
                            document.documentElement.webkitRequestFullscreen();
                        } else if (document.documentElement.mozRequestFullScreen) {
                            document.documentElement.mozRequestFullScreen();
                        } else if (document.documentElement.msRequestFullscreen) {
                            document.documentElement.msRequestFullscreen();
                        }
                    }
                }, 300);
            }
            
            function createParticles() {
                particlesContainer.innerHTML = '';
                for (let i = 0; i < 50; i++) {
                    const particle = document.createElement('div');
                    particle.classList.add('particle');
                    particle.style.left = `${Math.random() * 100}%`;
                    particle.style.top = `${Math.random() * 100}%`;
                    particle.style.width = `${Math.random() * 5 + 2}px`;
                    particle.style.height = particle.style.width;
                    particle.style.background = `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.random() * 0.5 + 0.3})`;
                    particle.style.animationDuration = `${Math.random() * 5 + 3}s`;
                    particle.style.animationDelay = `${Math.random() * 5}s`;
                    particlesContainer.appendChild(particle);
                }
            }
            
            function clearCurrentPlayback() {
                if (sourceNode) {
                    sourceNode.stop();
                    sourceNode.disconnect();
                    sourceNode = null;
                }
                
                audioBuffer = null;
                
                if (videoElement.src) {
                    videoElement.pause();
                    videoElement.src = '';
                    videoContainer.style.display = 'none';
                }
                
                isPlaying = false;
                playPauseBtn.textContent = '▶ 播放';
            }
                        
            // 加载默认视频（自动播放）
            function loadDefaultVideo() {
                try {
                    clearCurrentPlayback();
                    
                    if (audioContext) {
                        audioContext.close();
                    }
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    currentMediaSource = 'video';
                    videoContainer.style.display = 'block';
                    
                    // 即使视频URL失效也能进入，使用try-catch处理错误
                    try {
                        videoElement.src = defaultVideoUrl;
                        videoElement.loop = true;
                        
                        // 自动播放视频
                        videoElement.play().catch(e => {
                            console.log('视频自动播放被阻止:', e);
                            // 如果自动播放被阻止，显示播放按钮让用户手动触发
                            playPauseBtn.textContent = '▶ 播放';
                            isPlaying = false;
                        });
                    } catch (error) {
                        console.log('视频URL加载失败，继续显示播放器界面:', error);
                    }
                    
                    startButton.style.display = 'none';
                    playerContainer.style.display = 'block';
                    createParticles();
                    isPlaying = true;
                    playPauseBtn.textContent = '⏸ 暂停';
                    
                    // 自动全屏
                    autoFullscreen();
                } catch (error) {
                    console.error('加载视频错误:', error);
                    // 即使出错也继续显示播放器界面
                    startButton.style.display = 'none';
                    playerContainer.style.display = 'block';
                    createParticles();
                }
            }
            
            async function initAudio(customUrl = null, isFile = false, fileObject = null) {
                try {
                    clearCurrentPlayback();
                    
                    if (audioContext) {
                        await audioContext.close();
                    }
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    let arrayBuffer;
                    
                    if (isFile && fileObject) {
                        currentMediaSource = 'file';
                        arrayBuffer = await fileObject.arrayBuffer();
                        
                        if (fileObject.type.startsWith('video/')) {
                            videoContainer.style.display = 'block';
                            videoElement.src = URL.createObjectURL(fileObject);
                            videoElement.loop = isLooping;
                            videoElement.onloadedmetadata = function() {
                                videoElement.play().catch(e => console.log('视频播放错误:', e));
                            };
                        } else {
                            videoContainer.style.display = 'none';
                        }
                    } else if (customUrl) {
                        currentMediaSource = 'url';
                        videoContainer.style.display = 'none';
                        
                        const response = await fetch(customUrl, {
                            headers: {
                                'Accept': 'audio/mp3'
                            }
                        });
                        
                        if (!response.ok) throw new Error('无法加载音频');
                        arrayBuffer = await response.arrayBuffer();
                        audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    }
                    
                    startButton.style.display = 'none';
                    playerContainer.style.display = 'block';
                    createParticles();
                    
                    if (customUrl || isFile) {
                        playAudio();
                    }
                    
                    // 自动全屏
                    autoFullscreen();
                } catch (error) {
                    console.error('加载错误:', error);
                    alert('加载失败: ' + error.message);
                }
            }
            
            function playAudio() {
                if (!audioBuffer && currentMediaSource !== 'video') return;
                
                stopAudio();
                
                if (currentMediaSource === 'video') {
                    videoElement.play().catch(e => console.log('视频播放错误:', e));
                    isPlaying = true;
                    playPauseBtn.textContent = '⏸ 暂停';
                    return;
                }
                
                sourceNode = audioContext.createBufferSource();
                sourceNode.buffer = audioBuffer;
                sourceNode.loop = isLooping;
                sourceNode.playbackRate.value = playbackRate;
                sourceNode.detune.value = detune;
                
                const gainNode = audioContext.createGain();
                gainNode.gain.value = volumeControl.value;
                
                sourceNode.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                sourceNode.start(0);
                isPlaying = true;
                playPauseBtn.textContent = '⏸ 暂停';
                
                if (currentMediaSource === 'file' && videoContainer.style.display === 'block') {
                    videoElement.play().catch(e => console.log('视频播放错误:', e));
                }
            }
            
            function stopAudio() {
                if (sourceNode) {
                    try {
                        sourceNode.stop();
                    } catch(e) {
                        console.log('停止音频错误:', e);
                    }
                    sourceNode.disconnect();
                    isPlaying = false;
                }
                
                if (videoElement.src) {
                    videoElement.pause();
                }
            }
            
            // 搜索音乐函数
            async function searchMusic() {
                const keyword = musicSearchInput.value.trim();
                if (!keyword) {
                    alert('请输入搜索关键词');
                    return;
                }
                
                const api = apiSelector.value;
                searchResults.innerHTML = '<div style="padding: 20px; text-align: center;">搜索中...</div>';
                searchResults.style.display = 'block';
                
                try {
                    const response = await fetch(`https://api.i-meto.com/meting/api?server=${api}&type=search&id=${encodeURIComponent(keyword)}`);
                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        searchResults.innerHTML = '';
                        data.forEach((song, index) => {
                            const item = document.createElement('div');
                            item.className = 'search-result-item';
                            item.innerHTML = `
                                <img src="${song.pic}" class="result-cover" onerror="this.src='data:image/svg+xml;charset=UTF-8,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'40\' height=\'40\' viewBox=\'0 0 40 40\'%3E%3Crect fill=\'%233498db\' width=\'40\' height=\'40\'/%3E%3Ctext fill=\'%23ffffff\' font-family=\'Arial\' font-size=\'10\' x=\'50%25\' y=\'50%25\' dominant-baseline=\'middle\' text-anchor=\'middle\'%3E封面%3C/text%3E%3C/svg%3E'">
                                <div class="result-info">
                                    <div class="result-title">${song.name || song.title || '未知歌曲'}</div>
                                    <div class="result-artist">${song.artist || song.author || '未知艺术家'}</div>
                                </div>
                            `;
                            
                            item.addEventListener('click', () => {
                                playMusicFromAPI(song.url, song.name, song.artist, song.pic);
                                searchResults.style.display = 'none';
                            });
                            
                            searchResults.appendChild(item);
                        });
                    } else {
                        searchResults.innerHTML = '<div style="padding: 20px; text-align: center;">未找到结果</div>';
                    }
                } catch (error) {
                    console.error('搜索失败:', error);
                    searchResults.innerHTML = '<div style="padding: 20px; text-align: center;">搜索失败，请重试</div>';
                }
            }
            
            // 从API播放音乐
            async function playMusicFromAPI(url, title, artist, cover) {
                try {
                    clearCurrentPlayback();
                    
                    if (audioContext) {
                        await audioContext.close();
                    }
                    audioContext = new (window.AudioContext || window.webkitAudioCont)();
                    
                    currentMediaSource = 'api';
                    videoContainer.style.display = 'none';
                    
                    document.querySelector('.title').textContent = title || '心灵治愈音乐';
                    
                    const response = await fetch(url, {
                        headers: {
                            'Accept': 'audio/mp3',
                            'Referer': 'https://music.163.com/'
                        }
                    });
                    
                    if (!response.ok) throw new Error('无法加载音频');
                    const arrayBuffer = await response.arrayBuffer();
                    audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    
                    startButton.style.display = 'none';
                    playerContainer.style.display = 'block';
                    createParticles();
                    playAudio();
                    
                    // 自动全屏
                    autoFullscreen();
                } catch (error) {
                    console.error('播放失败:', error);
                    alert('播放失败: ' + error.message);
                }
            }
            
            // 更换背景图片
            function changeBackgroundImage(file) {
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.body.style.backgroundImage = `url(${e.target.result})`;
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            startButton.addEventListener('click', function() {
                loadDefaultVideo(); // 点击后自动加载并播放默认视频
            });
            
            playPauseBtn.addEventListener('click', function() {
                if (isPlaying) {
                    stopAudio();
                    playPauseBtn.textContent = '▶ 播放';
                } else {
                    playAudio();
                }
            });
            
            volumeControl.addEventListener('input', function() {
                if (sourceNode && audioContext) {
                    const gainNode = audioContext.createGain();
                    sourceNode.disconnect();
                    sourceNode.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    gainNode.gain.value = this.value;
                }
                
                if (videoElement.src) {
                    videoElement.volume = this.value;
                }
            });
            
            playbackRateControl.addEventListener('input', function() {
                playbackRate = parseFloat(this.value);
                if (isPlaying) {
                    playAudio();
                }
                
                if (videoElement.src) {
                    videoElement.playbackRate = playbackRate;
                }
            });
            
            pitchControl.addEventListener('input', function() {
                detune = (parseFloat(this.value) - 1) * 1200;
                if (isPlaying) {
                    playAudio();
                }
            });
            
            loopBtn.addEventListener('click', function() {
                isLooping = !isLooping;
                if (sourceNode) {
                    sourceNode.loop = isLooping;
                }
                this.classList.toggle('active');
                this.textContent = isLooping ? '🔁 循环中' : '🔁 单曲循环';
                
                if (videoElement.src) {
                    videoElement.loop = isLooping;
                }
            });
            
            urlSubmitBtn.addEventListener('click', function() {
                const url = audioUrlInput.value.trim();
                if (url) {
                    initAudio(url);
                } else {
                    alert('请输入有效的音频URL');
                }
            });
            
            audioUrlInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    urlSubmitBtn.click();
                }
            });
            
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    initAudio(null, true, file);
                }
            });
            
            // 背景图片更换事件
            bgChangeBtn.addEventListener('click', function() {
                bgImageInput.click();
            });
            
            bgImageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    changeBackgroundImage(file);
                }
            });
            
            // 全屏按钮事件
            fullscreenBtn.addEventListener('click', toggleFullscreen);
            
            // 音乐搜索事件监听
            musicSearchBtn.addEventListener('click', searchMusic);
            
            musicSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchMusic();
                }
            });
            
            // 点击其他地方关闭搜索结果
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.music-search-container')) {
                    searchResults.style.display = 'none';
                }
            });
            
            // 初始化MetingJS播放器
            initMetingPlayer();
            

            // 监听全屏变化
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
            document.addEventListener('mozfullscreenchange', handleFullscreenChange);
            document.addEventListener('MSFullscreenChange', handleFullscreenChange);
            
            function handleFullscreenChange() {
                if (!document.fullscreenElement && !document.webkitIsFullScreen && !document.mozFullScreen && !document.msFullscreenElement) {
                    // 如果用户退出全屏，尝试重新进入全屏
                    if (playerContainer.style.display === 'block') {
                        autoFullscreen();
                    }
                }
            }
        });
    </script>
 </body>
</html>